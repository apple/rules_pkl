amends "@pkl.impl.ghactions/PklCI.pkl"

import "@pkl.impl.ghactions/jobs/HawkeyeCheck.pkl"
import "@gha/actions/Common.pkl"
import "@gha/Context.pkl"
import "@gha/Workflow.pkl"

local test: Workflow = new {
  jobs {
    ["test"] {
      `runs-on` = "ubuntu-latest"
      steps {
        new Common.Checkout {}
        new {
          uses = "bazel-contrib/setup-bazel@4fd964a13a440a8aeb0be47350db2fc640f19ca8"
          with {
            ["bazelisk-cache"] = true
            ["disk-cache"] = "${{ matrix.os }}-cache"
            ["repository-cache"] = true
          }
        }
        new {
          name = "Buildifier lint"
          run = "bazel run --config=ci buildifier"
        }
        new {
          name = "Check gazelle"
          run =
            """
            bazel run --config=ci //:gazelle
            git diff --exit-code
            """
        }
        new {
          name = "Bazel version consistency"
          env {
            ["WORKING_DIRECTORY"] = Context.github.workspace
          }
          run = "bazel run --config=ci //tests/version:version_test -- --verbose"
        }
        new {
          name = "Bazel test"
          run = "bazel test --config=ci //..."
        }
      }
    }
    ["check-hawkeye"] = new HawkeyeCheck {}.job
  }
}

prb = test

build = test

main = test
